<!DOCTYPE html>
<html lang="en">
  <head>
    <title>WebRTC Broadcasting using RTCMultiConnection Â® Muaz Khan</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <link href="styles.css" rel="stylesheet" type="text/css" />
    
    <!-- scripts used for broadcasting -->
    <script src="socket.io.js"></script>
    <script src="RTCMultiConnection-v1.4.js"></script>
  </head>

  <body>
    <article>
      <header style="text-align: center;">
        <h1>
          <a href="https://www.webrtc-experiment.com/">WebRTC</a> Broadcasting using 
          <a href="https://github.com/muaz-khan/WebRTC-Experiment/tree/master/RTCMultiConnection" target="_blank">RTCMultiConnection</a>
        </h1>
      </header>

      <!-- just copy this <section> and next script -->
      <section class="experiment">
        <section>
          <span>
            Private ?? <a href="" target="_blank" title="Open this link in new tab. Then your room will be private!"><code><strong id="unique-token">#123456789</strong></code></a>
          </span>

          <input type="text" id="broadcast-name">
          <button id="setup-new-broadcast" class="setup">Setup New Broadcast</button>
        </section>
        <!-- list of all available broadcasting rooms -->
        <table style="width: 100%;" id="rooms-list"></table>
        <!-- local/remote videos container -->
        <div id="videos-container"></div>
      </section>

      <script>
        var connection = new RTCMultiConnection();
        connection.session = {
          audio: true,
          video: true,
          oneway: true
        };
        //connection.direction = 'one-to-many';
        connection.direction = 'many-to-many';

        // https://github.com/muaz-khan/WebRTC-Experiment/tree/master/socketio-over-nodejs
        connection.openSignalingChannel = function(config) {
          var SIGNALING_SERVER = 'https://www.webrtc-experiment.com:2015/';
          var channel = config.channel || this.channel || location.hash.substr(1);
          var sender = Math.round(Math.random() * 999999999) + 999999999;
          console.log(channel);
          console.log(sender);

          io.connect(SIGNALING_SERVER).emit('new-channel', {
            channel: channel,
            sender: sender
          });

          var socket = io.connect(SIGNALING_SERVER + channel);
          socket.channel = channel;
          socket.on('connect', function() {
            if (config.callback) config.callback(socket);
          });

          socket.send = function(message) {
            socket.emit('message', {
              sender: sender,
              data: message
            });
          };

          socket.on('message', config.onmessage);
        };

        connection.onstream = function(e) {
          videosContainer.insertBefore(e.mediaElement, videosContainer.firstChild);

          // rotate 360deg
          //e.mediaElement.style[navigator.mozGetUserMedia ? 'transform' : '-webkit-transform'] = 'rotate(0deg)';
          //setTimeout(function() {
          //    e.mediaElement.style[navigator.mozGetUserMedia ? 'transform' : '-webkit-transform'] = 'rotate(360deg)';
          //}, 1000);
        };

        var sessions = { };
        connection.onNewSession = function(session) {
          if (sessions[session.sessionid]) return;
          sessions[session.sessionid] = session;
          console.log("-------------------session before join-------------------");
          console.log(session);

          var tr = document.createElement('tr');
          tr.innerHTML = '<td><strong>' + session.extra['session-name'] + '</strong> is broadcasting his media!</td>' +
              '<td><button class="join">Join</button></td>';
          roomsList.insertBefore(tr, roomsList.firstChild);

          var joinRoomButton = tr.querySelector('.join');
          joinRoomButton.setAttribute('data-sessionid', session.sessionid);
          joinRoomButton.onclick = function() {
            this.disabled = true;

            var sessionid = this.getAttribute('data-sessionid');
            session = sessions[sessionid];

            if (!session) throw 'No such session exists.';
            console.log("-------------------session after join-------------------");
            console.log(session);

            connection.join(session);
          };
        };

        var videosContainer = document.getElementById('videos-container') || document.body;
        var roomsList = document.getElementById('rooms-list');

        document.getElementById('setup-new-broadcast').onclick = function() {
          this.disabled = true;
          connection.extra = {
            'session-name': document.getElementById('broadcast-name').value || 'Anonymous'
          };
          connection.open();
        };

        // setup signaling to search existing sessions
        connection.connect();

        (function() {
            var uniqueToken = document.getElementById('unique-token');
            if (uniqueToken)
                if (location.hash.length > 2) uniqueToken.parentNode.parentNode.parentNode.innerHTML = '<h2 style="text-align:center;"><a href="' + location.href + '" target="_blank">Share this link</a></h2>';
                else uniqueToken.innerHTML = uniqueToken.parentNode.parentNode.href = '#' + (Math.random() * new Date().getTime()).toString(36).toUpperCase().replace( /\./g , '-');
        })();
      </script>
    </article>
  </body>
</html>
